name: Process Logs, Upload 1Drive & Cleanup

on:
  workflow_dispatch:
    inputs:
      auth_key:
        description: 'Authentication key to authorize deletion'
        required: true
        type: string
  
  schedule:
    - cron: '0 22 * * *'

jobs:
  Auth:
    runs-on: ubuntu-latest
    outputs:
      active: ${{ steps.evaluate.outputs.active }}
    steps:
      - name: Authentication
        id: evaluate
        run: echo "active=${{ github.event.inputs.key == secrets.AUTH_KEY }}" >> $GITHUB_OUTPUT

  Build:
    needs: Auth
    if: ${{ needs.Auth.outputs.active == 'true' }}
    runs-on: ubuntu-latest
    environment: AutoBuild
    steps:
       - name: Test parameter
         run: |
            a=${{ github.event.inputs.ROM_URL }}
            c=${{ github.actor }}
            d=${{ github.server_url }}
            e=${{ github.repository }}
            f=${{ github.run_id }}
       - name: Clean 1
         run: |
            docker rmi `docker images -q` || true
            sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d || true
            sudo apt -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
            sudo apt -y autoremove --purge || true
            sudo apt -y autoclean || true
            sudo apt clean || true
       - name: Clean 2
         uses: easimon/maximize-build-space@master
         with:
            root-reserve-mb: 512
            swap-size-mb: 1024
            remove-dotnet: "true"
            remove-android: "true"
            remove-haskell: "true"

       - name: Checkout
         uses: actions/checkout@v3
         with:
            ref: PREVIEW
            ssh-key: ${{ secrets.CLONEC_KEY }}
            repository: buihien224/colour_erofs_tool

       - name: Setting up
         run: |
            sudo apt-get update
            sudo apt-get install -y git lz4 wget zip unzip android-sdk-libsparse-utils brotli axel python3-pip zipalign apksigner xmlstarlet aapt p7zip-full device-tree-compiler aria2
            sudo pip3 install ConfigObj
            sudo pip3 install telebot
       - name: Set up VIETSUB
         run: |
            cd "$GITHUB_WORKSPACE"
            echo "Setting Vietnam timezone"
            sudo timedatectl set-timezone Asia/Ho_Chi_Minh
       - name: Set up Rclone
         run: |
            cd "$GITHUB_WORKSPACE"
            mkdir -p bin
            aria2c -x 16 -s 16 -j 1 -o bin/rclone1 https://github.com/buihien224/toolbox_notification/releases/download/rclone/rclone1
            chmod +x bin/rclone1

       - name: Run Rclone Task
         run: |
           ./bin/rclone1 lsd 1drive1: --config rclone.conf       

       - name: Scan Logs & Upload to OneDrive
         env:
          GH_TOKEN: ${{ github.token }}
         run: |
          echo "Scanning recent workflow runs for logs..."
          
          # Lấy danh sách 10 lần chạy gần nhất
          RUN_IDS=$(gh run list --limit 10 --json databaseId -q '.[].databaseId')

          # Lấy ngày hiện tại format: 04-12-2025
          CURRENT_DATE=$(date +"%d-%m-%Y")

          for id in $RUN_IDS; do
            echo "Processing Run ID: $id"
            
            # Tải log về file tạm
            gh run view $id --log > temp_log.txt 2>/dev/null || true
            
            if [ -s temp_log.txt ]; then
              # Tìm kiếm tên thiết bị trong log
              # Pattern: [Initialization][vsteam][Device][PGEM10]
              DEVICE=$(grep "\[Initialization\]\[vsteam\]\[Device\]" temp_log.txt | head -1 | awk -F'[][]' '{print $8}')
              
              if [[ ! -z "$DEVICE" ]]; then
                echo "Found Device: $DEVICE in Run $id"
                
                # Định nghĩa đường dẫn đích: log/04-12-2025/PGEM10/run_12345.log
                TARGET_PATH="1drive1:log/$CURRENT_DATE/$DEVICE/run_$id.log"
                
                echo "Uploading to: $TARGET_PATH"
                
                # Thực hiện upload bằng rclone1
                ./bin/rclone1 copy temp_log.txt "$TARGET_PATH" --config rclone.conf
                
              else
                echo "Device name not found in Run $id, skipping upload."
              fi
            fi
            # Dọn dẹp file tạm
            rm -f temp_log.txt
          done

      - name: Delete All Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
          dry_run: false
