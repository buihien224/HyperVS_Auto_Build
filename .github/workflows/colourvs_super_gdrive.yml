name: coloros_super_create2

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'Select device code'
        required: true
        default: 'PKG110'
        type: choice 
        options:
          - PLK110
          - PLQ110
          - PJZ110
          - PKX110
          - PKG110
          - PKR110
          - PLF110
          - PLC110
          - PJE110
          - PJX110
          - PJF110
          - PJD110
          - OPD2413
          - OPD2404
          - RMX6699
          - RMX5200
          - RMX5010
          - RMX5090
          - RMX6688
          - RMX3800
          - RMX3888
          - RMX5060
          - RMX5062
          - RMX5080
          - RMX5071
          - PKT110
          - PKC110
          - PKB110
          - PLB110
          - Custom

      CUSTOM_URL:
        description: 'Custom'
        required: false
        default: ''

      key:
        description: 'Active Key'
        required: true
        default: ''
      trigger:
        description: 'Trigger name'
        required: true
        default: 'Auto_Build'

jobs:
  Auth:
    runs-on: ubuntu-latest
    outputs:
      active: ${{ steps.evaluate.outputs.active }}
    steps:
      - name: Authentication
        id: evaluate
        run: echo "active=${{ github.event.inputs.key == secrets.AUTH_KEY }}" >> $GITHUB_OUTPUT

  Build:
    needs: Auth
    if: ${{ needs.Auth.outputs.active == 'true' }}
    runs-on: ubuntu-latest
    environment: AutoBuild
    steps:
      - name: Test parameter
        run: |
          echo "ROM Option: ${{ github.event.inputs.ROM_URL }}"
          echo "Custom Input: ${{ github.event.inputs.CUSTOM_URL }}"
          echo "User: ${{ github.actor }}"
          echo "Server: ${{ github.server_url }}"
          echo "Repo: ${{ github.repository }}"
          echo "Run ID: ${{ github.run_id }}"
          
      - name: Clean 1
        run: |
          docker rmi `docker images -q` || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d || true
          sudo apt -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo apt -y autoremove --purge || true
          sudo apt -y autoclean || true
          sudo apt clean || true

      - name: Clean 2
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: PREVIEW
          ssh-key: ${{ secrets.CLONEC_KEY }}
          repository: buihien224/colour_erofs_tool
      
      - name: Setting up
        run: |
          sudo apt-get install -y git lz4 wget zip unzip android-sdk-libsparse-utils brotli axel python3-pip zipalign apksigner xmlstarlet aapt p7zip-full device-tree-compiler aria2
          sudo pip3 install ConfigObj
          sudo pip3 install telebot
          
      - name: Set up VIETSUB 
        run: |
          cd $GITHUB_WORKSPACE
          echo "Setting Vietnam timezone"
          sudo timedatectl set-timezone Asia/Ho_Chi_Minh
          
      - name: Set up Rclone
        run: |
          cd "$GITHUB_WORKSPACE"
          mkdir -p bin
          aria2c -x 16 -s 16 -j 1 -o bin/rclone1 https://github.com/buihien224/toolbox_notification/releases/download/rclone/rclone1
          chmod +x bin/rclone1

      - name: Download ROM
        run: |
            set -e
            OPTION="${{ github.event.inputs.ROM_URL }}"
            CUSTOM="${{ github.event.inputs.CUSTOM_URL }}"
            if [ "$OPTION" == "Custom" ]; then
              if [ -z "$CUSTOM" ]; then
                echo "âŒ Error: You selected 'Custom' but did not paste a link/prefix in the 'CUSTOM_URL' box!"
                exit 1
              fi
              INPUT="$CUSTOM"
              echo "â„¹ï¸ Mode: Custom Input selected."
            else
              INPUT="$OPTION"
              echo "â„¹ï¸ Mode: Preset Device selected ($OPTION)."
            fi
            LENGTH=${#INPUT}            
            if [ "$LENGTH" -gt 10 ]; then
              echo "Input length: $LENGTH (>10). Detected Direct URL."
              echo "ðŸš€ Starting high-speed download with aria2..."
              aria2c -x16 -s16 -k1M --check-certificate=false "$INPUT"              
            else
              echo "Input length: $LENGTH (<=10). Detected Filename Prefix."              
              echo "ðŸ” Searching in 1drive1:/Mirror for prefix: ${INPUT}..."
              FILE="$(./bin/rclone1 --config bin/lsc.conf lsf '1drive1:/Mirror' --files-only --include "${INPUT}*" | head -n1)"
              if [ -n "$FILE" ]; then
                echo "âœ… Found in OneDrive: $FILE"
                SOURCE_PATH="1drive1:/Mirror"
              else
                echo "âš ï¸ Not found in OneDrive. Searching in gdrive1:/VS_Stock..."
                FILE="$(./bin/rclone1 --config bin/lsc.conf lsf 'gdrive1:/VS_Stock' --files-only --include "${INPUT}*" | head -n1)"
                if [ -n "$FILE" ]; then
                  echo "âœ… Found in GDrive: $FILE"
                  SOURCE_PATH="gdrive1:/VS_Stock"
                fi
              fi
              if [ -z "$FILE" ]; then
                echo "âŒ Error: No file found starting with '${INPUT}' in both OneDrive and GDrive!"
                exit 1
              fi
              echo "â¬‡ï¸ Downloading $FILE from $SOURCE_PATH with MAX SPEED..."
              
              ./bin/rclone1 --config bin/lsc.conf copy "$SOURCE_PATH/$FILE" . \
                --transfers=4 \
                --checkers=8 \
                --multi-thread-streams=16 \
                --buffer-size=64M \
                --drive-chunk-size=64M \
                --ignore-checksum \
                --no-update-modtime \
                --no-check-dest \
                --progress
            fi
            echo "ðŸŽ‰ Download/Check process completed. Content:"
            ls -lh

      - name: Init project
        run: |
                OPTION="${{ github.event.inputs.ROM_URL }}"
                CUSTOM="${{ github.event.inputs.CUSTOM_URL }}"
                if [ "$OPTION" == "Custom" ]; then
                  FINAL_INPUT="$CUSTOM"
                else
                  FINAL_INPUT="$OPTION"
                fi
                
                echo "Passing to Init: $FINAL_INPUT"
                ./bhlnk -i ${{ github.event.inputs.trigger }} "$FINAL_INPUT" true
                sudo chmod 777 -R *

      - name: Extract state
        run: |
          ./bhlnk -p extract    

      - name: Patch VS
        run: |
          ./bhlnk -p patchvs     

      - name: Re-create partition 
        run: |
          ./bhlnk -p pack 

      - name: Set up Rclone (Re-init)
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p bin
          rm -f bin/rclone1
          aria2c -x 16 -s 16 -j 1 -o bin/rclone1 https://github.com/buihien224/toolbox_notification/releases/download/rclone/rclone1
          chmod +x bin/rclone1

      - name: Upload
        run: |
          ./bhlnk -u || exit 0 
          echo "Upload returned 0. Exiting workflow."
          exit 1